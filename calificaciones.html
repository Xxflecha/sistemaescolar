<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Calificaciones - Alumno</title>
  <style>
    body { margin: 0; font-family: 'Segoe UI', Arial, sans-serif; background: #f4f7fb; }
    .header {
      background: #1846b6;
      color: #fff;
      display: flex;
      align-items: center;
      padding: 0 30px;
      height: 70px;
      position: relative;
    }
    .header img { height: 48px; margin-right: 18px; }
    .header-title { font-size: 2em; font-family: 'Habibi', serif; flex: 1; }
    .avatar { width: 80px; height: 80px; border-radius: 50%; background: #fff; display: flex; align-items: center; justify-content: center; overflow: hidden; margin-left: 10px; cursor: pointer; border: 2px solid #fff; }
    .avatar img { width: 100%; height: 100%; object-fit: cover; }
    .menu-hamburguesa {
      width: 48px;
      height: 48px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      cursor: pointer;
      margin-right: 18px;
      z-index: 1001;
    }
    .menu-hamburguesa span {
      display: block;
      height: 5px;
      width: 32px;
      background: #fff;
      margin: 5px 0;
      border-radius: 2px;
      transition: 0.2s;
    }
    .menu-desplegable {
      display: none;
      position: absolute;
      top: 70px;
      left: 10px;
      background: #fff;
      color: #1846b6;
      border-radius: 12px;
      box-shadow: 0 4px 16px rgba(24,70,182,0.12);
      min-width: 180px;
      z-index: 2000;
      flex-direction: column;
      padding: 10px 0;
    }
    .menu-desplegable a {
      color: #1846b6;
      text-decoration: none;
      font-size: 1.1em;
      padding: 12px 30px;
      border-radius: 0 18px 18px 0;
      transition: background 0.2s, color 0.2s;
      margin-right: 10px;
      display: block;
      cursor: pointer;
    }
    .menu-desplegable a:hover {
      background: #e5e7eb;
      color: #0d2a6b;
      font-weight: bold;
    }
    .main-content {
      max-width: 900px;
      margin: 40px auto 0 auto;
      padding: 0 20px 40px 20px;
    }
    .info-card {
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(24,70,182,0.08);
      padding: 30px;
      margin-bottom: 30px;
    }
    .calif-table {
      border-collapse: collapse;
      width: 100%;
      margin-top: 18px;
      background: #fff;
      box-shadow: 0 2px 8px rgba(24,70,182,0.04);
      border-radius: 8px;
      overflow: hidden;
    }
    .calif-table th, .calif-table td {
      border: 1px solid #bdbdbd;
      padding: 8px 10px;
      text-align: center;
    }
    .calif-table th {
      background: #bfa16c;
      color: #fff;
      font-weight: bold;
    }
    .calif-table tr:nth-child(even) { background: #f9fafb; }
    .calif-table tr:hover { background: #f3f4f6; }
    .error-message { color: #c00; margin-bottom: 10px; font-size: 1em; }
    @media (max-width: 900px) {
      .main-content { max-width: 98vw; padding: 0 5vw 40px 5vw; }
    }
  </style>
</head>
<body>
  <div class="header">
    <div class="menu-hamburguesa" id="menuBtn">
      <span></span>
      <span></span>
      <span></span>
    </div>
    <img src="public/tecnologico.png" alt="Logo TecNM">
    <span class="header-title">Ingenieria En Sistemas Computacionales</span>
    <div class="avatar" id="avatar">
      <img id="foto-perfil" src="https://cdn-icons-png.flaticon.com/512/4140/4140048.png" alt="Foto de perfil">
    </div>
    <div class="menu-desplegable" id="menuDesplegable">
      <a onclick="irA('alumnos.html')">Inicio</a>
      <a onclick="irA('calificaciones.html')">Calificaciones</a>
      <a onclick="irA('horario.html')">Horario</a>
      <a onclick="irA('kardex.html')">Kardex</a>
      <a onclick="cerrarSesion()">Cerrar sesión</a>
    </div>
  </div>
  <div class="main-content">
    <div class="info-card" id="alumno-info">
      <!-- Aquí se muestra la información del alumno -->
    </div>
    <div class="info-card">
      <h2>Calificaciones</h2>
      <label for="periodoSelect">Selecciona periodo:</label>
      <select id="periodoSelect"></select>
      <table class="calif-table" id="tabla-calif">
        <thead>
          <tr>
            <th>Clave</th>
            <th>Materia</th>
            <th>Docente</th>
            <th>Calificación</th>
            <th>Repite</th>
            <th>Créditos</th>
            <th>Periodo</th>
          </tr>
        </thead>
        <tbody id="calif-body">
          <!-- Calificaciones dinámicas -->
        </tbody>
      </table>
      <div class="error-message" id="errorMsg" style="display:none;"></div>
    </div>
  </div>
  <script>
    // Menú hamburguesa
    document.getElementById('menuBtn').onclick = function(e) {
      const menu = document.getElementById('menuDesplegable');
      menu.style.display = menu.style.display === 'flex' ? 'none' : 'flex';
      menu.style.flexDirection = 'column';
      e.stopPropagation();
    };
    document.body.onclick = function() {
      document.getElementById('menuDesplegable').style.display = 'none';
    };
    document.getElementById('menuDesplegable').onclick = function(e) {
      e.stopPropagation();
    };
    function irA(pagina) {
      window.location.href = pagina;
    }
    function cerrarSesion() {
      localStorage.removeItem('alumno');
      window.location.href = 'indexSP.html';
    }

    // Cargar datos del alumno desde localStorage y mostrar info
    let alumno = null;
    document.addEventListener('DOMContentLoaded', function() {
      alumno = JSON.parse(localStorage.getItem('alumno'));
      if (!alumno) {
        window.location.href = 'indexSP.html';
        return;
      }
      // Foto de perfil
      if (alumno.foto_perfil) {
        document.getElementById('foto-perfil').src = alumno.foto_perfil;
      }
      // Info alumno (ahora incluye periodo_actual)
      document.getElementById('alumno-info').innerHTML = `
        <b>${alumno.nombre || ''} ${alumno.apellido_paterno || ''} ${alumno.apellido_materno || ''}</b><br>
        No. Control: ${alumno.no_control || ''} &nbsp; | &nbsp; Carrera: ${alumno.carrera || ''} &nbsp; | &nbsp; Semestre: ${alumno.semestre || ''}<br>
        Periodo actual: <b>${alumno.periodo_actual || 'N/D'}</b><br>
        Correo: ${alumno.correo_personal || ''} &nbsp; | &nbsp; Teléfono: ${alumno.telefono || ''}
      `;
      cargarPeriodos();
    });

    async function cargarPeriodos() {
      const res = await fetch('http://localhost:4000/api/periodos');
      const periodos = await res.json();
      const select = document.getElementById('periodoSelect');
      select.innerHTML = '';
      periodos.forEach(p => {
        const opt = document.createElement('option');
        opt.value = p.nombre;
        opt.textContent = p.nombre;
        select.appendChild(opt);
      });
      select.value = alumno.periodo_actual || periodos[0]?.nombre;
      cargarCalificaciones(select.value);
      select.onchange = () => cargarCalificaciones(select.value);
    }

    // Cargar calificaciones solo del periodo actual
    async function cargarCalificaciones(periodo_nombre) {
      const tbody = document.getElementById('calif-body');
      tbody.innerHTML = '';
      document.getElementById('errorMsg').style.display = 'none';
      try {
        const res = await fetch(`http://localhost:4000/api/calificaciones/${alumno.id}?periodo=${encodeURIComponent(periodo_nombre)}`);
        if (!res.ok) throw new Error('No se pudieron cargar las calificaciones');
        const califs = await res.json();
        if (!Array.isArray(califs) || califs.length === 0) {
          tbody.innerHTML = '<tr><td colspan="7">No hay calificaciones registradas para este periodo.</td></tr>';
          return;
        }
        califs.forEach(c => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${c.clave_materia || ''}</td>
            <td>${c.nombre_materia || ''}</td>
            <td>${c.docente || ''}</td>
            <td>${c.calificacion || ''}</td>
            <td></td>
            <td>${c.creditos || ''}</td>
            <td>${c.periodo || ''}</td>
          `;
          tbody.appendChild(tr);
        });
      } catch (err) {
        document.getElementById('errorMsg').textContent = 'Error al cargar calificaciones';
        document.getElementById('errorMsg').style.display = 'block';
      }
    }
  </script>
</body>
</html>

