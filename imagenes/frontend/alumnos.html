<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Alumno - Ingeniería en Sistemas Computacionales</title>
  <style>
    body { margin: 0; font-family: 'Segoe UI', Arial, sans-serif; background: #f4f7fb; }
    .header {
      background: #1846b6;
      color: #fff;
      display: flex;
      align-items: center;
      padding: 0 30px;
      height: 70px;
      position: relative;
    }
    .header img { height: 48px; margin-right: 18px; }
    .header-title { font-size: 2em; font-family: 'Habibi', serif; flex: 1; }
    .avatar { width: 80px; height: 80px; border-radius: 50%; background: #fff; display: flex; align-items: center; justify-content: center; overflow: hidden; margin-left: 10px; cursor: pointer; border: 2px solid #fff; }
    .avatar img { width: 100%; height: 100%; object-fit: cover; }
    /* Menú hamburguesa */
    .menu-hamburguesa {
      width: 48px;
      height: 48px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      cursor: pointer;
      margin-right: 18px;
      z-index: 1001;
    }
    .menu-hamburguesa span {
      display: block;
      height: 5px;
      width: 32px;
      background: #fff;
      margin: 5px 0;
      border-radius: 2px;
      transition: 0.2s;
    }
    /* Menú desplegable */
    .menu-desplegable {
      display: none;
      position: absolute;
      top: 70px;
      left: 10px;
      background: #fff;
      color: #1846b6;
      border-radius: 12px;
      box-shadow: 0 4px 16px rgba(24,70,182,0.12);
      min-width: 180px;
      z-index: 2000;
      flex-direction: column;
      padding: 10px 0;
    }
    .menu-desplegable a {
      color: #1846b6;
      text-decoration: none;
      font-size: 1.1em;
      padding: 12px 30px;
      border-radius: 0 18px 18px 0;
      transition: background 0.2s, color 0.2s;
      margin-right: 10px;
      display: block;
      cursor: pointer;
    }
    .menu-desplegable a:hover {
      background: #e5e7eb;
      color: #0d2a6b;
      font-weight: bold;
    }
    .main-content {
      max-width: 900px;
      margin: 40px auto 0 auto;
      padding: 0 20px 40px 20px;
    }
    .info-card {
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(24,70,182,0.08);
      padding: 30px;
      margin-bottom: 30px;
    }
    .info-row { display: flex; align-items: center; gap: 30px; }
    .info-table { border-collapse: collapse; width: 100%; margin-bottom: 18px; }
    .info-table th, .info-table td { border: 1px solid #ccc; padding: 8px 12px; text-align: left; }
    .info-table th { background: #f3f4f6; color: #222; font-weight: bold; }
    .info-table td { background: #fff; }
    .section-title { font-size: 1.3em; font-weight: bold; margin: 30px 0 18px 0; color: #1846b6; }
    .edit-btn, .save-btn { background: #1846b6; color: #fff; border: none; border-radius: 8px; padding: 8px 22px; font-size: 1em; cursor: pointer; margin-top: 10px; }
    .edit-btn:hover, .save-btn:hover { background: #0d2a6b; }
    .photo-upload { display: flex; flex-direction: column; align-items: center; gap: 8px; }
    .photo-upload input[type="file"] { display: none; }
    .photo-label { background: #e5e7eb; color: #1846b6; border-radius: 6px; padding: 6px 14px; cursor: pointer; font-size: 0.95em; }
    .error-message { color: #c00; margin-bottom: 10px; font-size: 1em; }
    @media (max-width: 900px) {
      .main-content { max-width: 98vw; padding: 0 5vw 40px 5vw; }
      .info-row { flex-direction: column; gap: 10px; }
    }
  </style>
</head>
<body>
  <div class="header">
    <div class="menu-hamburguesa" id="menuBtn">
      <span></span>
      <span></span>
      <span></span>
    </div>
    <img src="public/tecnologico.png" alt="Logo TecNM">
    <span class="header-title">Ingenieria En Sistemas Computacionales</span>
    <div class="avatar" id="avatar">
      <img id="foto-perfil" src="https://cdn-icons-png.flaticon.com/512/4140/4140048.png" alt="Foto de perfil">
    </div>
    <div class="menu-desplegable" id="menuDesplegable">
      <a onclick="irA('alumnos.html')">Inicio</a>
      <a onclick="irA('calificaciones.html')">Calificaciones</a>
      <a onclick="irA('horario.html')">Horario</a>
      <a onclick="irA('kardex.html')">Kardex</a>
      <a onclick="cerrarSesion()">Cerrar sesión</a>
    </div>
  </div>
  <div class="main-content">
    <div class="info-card">
      <div class="info-row">
        <div class="photo-upload">
          <img id="foto-perfil-big" src="https://cdn-icons-png.flaticon.com/512/4140/4140048.png" alt="Foto de perfil" style="width:120px;height:120px;border-radius:50%;border:2px solid #1846b6;">
          <label class="photo-label" for="input-foto">Subir foto</label>
          <input type="file" id="input-foto" accept="image/*">
        </div>
        <table class="info-table">
          <tr>
            <th>No. Control</th>
            <td id="al-no_control"></td>
            <th>Nombre</th>
            <td id="al-nombre"></td>
            <th>CURP</th>
            <td id="al-curp"></td>
          </tr>
          <tr>
            <th>Modalidad</th>
            <td id="al-modalidad"></td>
            <th>Carrera</th>
            <td id="al-carrera"></td>
            <th>Plan</th>
            <td id="al-plan"></td>
          </tr>
          <tr>
            <th>Especialidad</th>
            <td id="al-especialidad"></td>
            <th>Semestre</th>
            <td id="al-semestre"></td>
            <th>Créditos</th>
            <td id="al-creditos"></td>
          </tr>
        </table>
      </div>
      <div style="margin-top:18px;">
        <div class="section-title">Datos personales</div>
        <div><b>Correo Personal:</b> <span id="al-correo_personal"></span></div>
        <div><b>Teléfono:</b> <span id="al-telefono"></span></div>
        <div><b>Fecha de Nacimiento:</b> <span id="al-fecha_nacimiento"></span></div>
        <button class="edit-btn" id="editarBtn">Modificar datos</button>
        <button class="save-btn" id="guardarBtn" style="display:none;">Guardar</button>
        <div class="error-message" id="errorMsg" style="display:none;"></div>
      </div>
    </div>
    <!-- Periodo actual -->
    <div style="background:#fff;border-radius:12px;padding:18px 24px;margin-top:30px;box-shadow:0 2px 8px rgba(24,70,182,0.08);">
      <div class="section-title" style="margin:0 0 18px 0;">Periodo actual</div>
      <div id="periodoActual" style="font-size:1.1em;color:#1846b6;"></div>
    </div>
  </div>
  <script>
    // Menú hamburguesa
    document.getElementById('menuBtn').onclick = function(e) {
      const menu = document.getElementById('menuDesplegable');
      menu.style.display = menu.style.display === 'flex' ? 'none' : 'flex';
      menu.style.flexDirection = 'column';
      e.stopPropagation();
    };
    document.body.onclick = function() {
      document.getElementById('menuDesplegable').style.display = 'none';
    };
    document.getElementById('menuDesplegable').onclick = function(e) {
      e.stopPropagation();
    };
    function irA(pagina) {
      window.location.href = pagina;
    }

    // Cargar datos del alumno desde localStorage
    let alumno = null;
    document.addEventListener('DOMContentLoaded', function() {
      alumno = JSON.parse(localStorage.getItem('alumno'));
      if (!alumno) {
        window.location.href = 'indexSP.html';
        return;
      }
      // Foto de perfil
      if (alumno.foto_perfil) {
        // Si la ruta no es absoluta, agrégale el host del backend
        let fotoUrl = alumno.foto_perfil;
        if (!/^https?:\/\//.test(fotoUrl)) {
          fotoUrl = 'http://localhost:4000' + fotoUrl;
        }
        document.getElementById('foto-perfil').src = fotoUrl;
        document.getElementById('foto-perfil-big').src = fotoUrl;
      }
      // Datos generales
      document.getElementById('al-no_control').textContent = alumno.no_control || '';
      document.getElementById('al-nombre').textContent = `${alumno.nombre || ''} ${alumno.apellido_paterno || ''} ${alumno.apellido_materno || ''}`;
      document.getElementById('al-curp').textContent = alumno.curp || '';
      document.getElementById('al-modalidad').textContent = alumno.modalidad || '';
      document.getElementById('al-carrera').textContent = alumno.carrera || '';
      document.getElementById('al-plan').textContent = alumno.plan_estudios || '';
      document.getElementById('al-especialidad').textContent = alumno.especialidad || '';
      document.getElementById('al-semestre').textContent = alumno.semestre || '';
      document.getElementById('al-creditos').textContent = alumno.creditos_plan || '';
      // Periodo actual
      // Agrega esto donde quieras mostrar el periodo actual, por ejemplo debajo de la tabla principal:
      const tabla = document.querySelector('.info-table');
      if (tabla && alumno.periodo_actual) {
        let filaPeriodo = document.getElementById('fila-periodo-actual');
        if (!filaPeriodo) {
          filaPeriodo = document.createElement('tr');
          filaPeriodo.id = 'fila-periodo-actual';
          filaPeriodo.innerHTML = `<th>Periodo actual</th><td colspan="5"><b>${alumno.periodo_actual}</b></td>`;
          tabla.appendChild(filaPeriodo);
        }
      }
      // Datos personales
      document.getElementById('al-correo_personal').textContent = alumno.correo_personal || '';
      document.getElementById('al-telefono').textContent = alumno.telefono || '';
      document.getElementById('al-fecha_nacimiento').textContent = alumno.fecha_nacimiento ? alumno.fecha_nacimiento.split('T')[0] : '';
      // Periodo actual - Nueva sección
      document.getElementById('periodoActual').innerHTML = `Periodo actual: <b>${alumno.periodo_actual || 'N/D'}</b>`;
    });

    // Subir foto de perfil
    document.getElementById('input-foto').addEventListener('change', async function(e) {
      const file = e.target.files[0];
      if (!file) return;
      const formData = new FormData();
      formData.append('foto', file);
      try {
        const res = await fetch(`http://localhost:4000/api/alumnos/${alumno.id}/foto`, {
          method: 'POST',
          body: formData
        });
        const data = await res.json();
        if (data.success && data.fotoUrl) {
          document.getElementById('foto-perfil').src = data.fotoUrl;
          document.getElementById('foto-perfil-big').src = data.fotoUrl;
          alumno.foto_perfil = data.fotoUrl;
          localStorage.setItem('alumno', JSON.stringify(alumno));
        } else {
          alert('Error al subir la foto');
        }
      } catch (err) {
        alert('Error al subir la foto');
      }
    });

    // Editar datos personales
    document.getElementById('editarBtn').onclick = function() {
      ['al-correo_personal','al-telefono'].forEach(id => {
        const span = document.getElementById(id);
        const input = document.createElement('input');
        input.type = id === 'al-correo_personal' ? 'email' : 'text';
        input.value = span.textContent;
        input.style.width = '120px';
        span.parentNode.replaceChild(input, span);
      });
      this.style.display = 'none';
      document.getElementById('guardarBtn').style.display = '';
    };

    document.getElementById('guardarBtn').onclick = async function() {
      const campos = ['al-correo_personal','al-telefono'];
      const datos = {};
      let error = false;
      campos.forEach(id => {
        const input = document.querySelector(`#${id}`);
        if (!input || input.tagName !== 'INPUT') {
          error = true;
        } else {
          datos[id.replace('al-','')] = input.value;
        }
      });
      if (error) {
        document.getElementById('errorMsg').textContent = 'Error al guardar datos';
        document.getElementById('errorMsg').style.display = 'block';
        return;
      }
      this.disabled = true;
      try {
        // Asegura que los datos sean string (por si acaso)
        if (datos.telefono) datos.telefono = String(datos.telefono);
        if (datos.correo_personal) datos.correo_personal = String(datos.correo_personal);
        const res = await fetch(`http://localhost:4000/api/alumnos/${alumno.id}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(datos)
        });
        const data = await res.json();
        if (data.success) {
          // Actualiza la UI y localStorage
          campos.forEach(id => {
            const input = document.querySelector(`#${id}`);
            if (input && input.tagName === 'INPUT') {
              const span = document.createElement('span');
              span.id = id;
              span.textContent = input.value;
              input.parentNode.replaceChild(span, input);
            }
          });
          Object.assign(alumno, datos);
          localStorage.setItem('alumno', JSON.stringify(alumno));
          document.getElementById('editarBtn').style.display = '';
          this.style.display = 'none';
          document.getElementById('errorMsg').style.display = 'none';
        } else {
          document.getElementById('errorMsg').textContent = data.message || 'Error al guardar datos';
          document.getElementById('errorMsg').style.display = 'block';
        }
      } catch (err) {
        document.getElementById('errorMsg').textContent = 'Error al guardar datos';
        document.getElementById('errorMsg').style.display = 'block';
      }
      this.disabled = false;
    };

    // Cerrar sesión
    function cerrarSesion() {
      localStorage.removeItem('alumno');
      window.location.href = 'indexSP.html';
    }
  </script>
</body>
</html>
